<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subtraction Tower</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        
        .game-container {
            background-color: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-width: 900px;
            width: 100%;
            text-align: center;
        }
        
        h1 {
            color: #2196F3;
            margin-bottom: 15px;
        }
        
        .game-info {
            background-color: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .players-container {
            display: flex;
            justify-content: space-between;
            gap: 30px;
            margin-bottom: 20px;
        }
        
        .player-display {
            flex: 1;
            padding: 25px;
            border-radius: 15px;
            border: 3px solid #ddd;
            transition: all 0.3s ease;
            background-color: #fafafa;
        }
        
        .player-display.active {
            border-color: #2196F3;
            background-color: #e3f2fd;
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }
        
        .player-display.winner {
            border-color: #4CAF50;
            background-color: #e8f5e8;
            animation: celebration 2s ease-in-out infinite;
        }
        
        @keyframes celebration {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .player-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        
        .player-display.active .player-name {
            color: #2196F3;
        }
        
        .player-display.winner .player-name {
            color: #4CAF50;
        }
        
        .player-value {
            font-size: 48px;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }
        
        .player-display.active .player-value {
            color: #1976D2;
        }
        
        .player-display.winner .player-value {
            color: #2e7d32;
        }
        
        .tower-visual {
            margin: 15px 0;
            height: 120px;
            background: linear-gradient(to top, #4CAF50 0%, #81C784 100%);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .tower-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(to top, #2196F3 0%, #64B5F6 100%);
            border-radius: 0 0 10px 10px;
            transition: height 0.8s ease;
        }
        
        .problem-area {
            background-color: #fff3e0;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border: 2px solid #FF9800;
        }
        
        .current-turn {
            font-size: 18px;
            font-weight: bold;
            color: #FF9800;
            margin-bottom: 10px;
        }
        
        .problem-display {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            flex: 1;
            text-align: left;
        }
        
        .problem-control {
            display: flex;
            align-items: center;
            gap: 20px;
            justify-content: flex-start;
            margin-top: 15px;
        }
        
        .spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: conic-gradient(
                #FF5722 0deg 60deg,
                #FF9800 60deg 120deg,
                #FFC107 120deg 180deg,
                #4CAF50 180deg 240deg,
                #2196F3 240deg 300deg,
                #9C27B0 300deg 360deg
            );
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s ease;
            border: 2px solid #333;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .spinner:hover {
            transform: scale(1.05);
        }
        
        .spinner.spinning {
            animation: spin 2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(1800deg); }
        }
        
        .spinner-center {
            width: 28px;
            height: 28px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: #333;
            border: 1px solid #333;
        }
        
        .subtraction-workspace {
            background-color: #e8f5e8;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            border: 2px solid #4CAF50;
        }
        
        .workspace-title {
            font-size: 22px;
            font-weight: bold;
            color: #2e7d32;
            margin-bottom: 20px;
        }
        
        .subtraction-problem {
            background-color: white;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .problem-row {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            margin: 8px 0;
            gap: 0px;
        }
        
        .digit-column {
            position: relative;
            width: 60px;
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            cursor: pointer;
        }
        
        .top-number .digit-column {
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .top-number .digit-column:hover {
            background-color: #e3f2fd;
            transform: scale(1.05);
        }
        
        .borrow-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 16px;
            height: 16px;
            border-radius: 3px;
            background-color: #f44336;
            color: white;
            font-size: 12px;
            font-weight: bold;
            display: none;
            align-items: center;
            justify-content: center;
            animation: borrowPulse 0.5s ease-out;
            z-index: 10;
        }
        
        .borrow-indicator.show {
            display: flex;
        }
        
        @keyframes borrowPulse {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .digit {
            font-size: 32px;
            font-weight: bold;
            color: #333;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }
        
        .digit.crossed-out {
            text-decoration: line-through;
            color: #999;
            position: relative;
        }
        
        .digit.borrowed {
            color: #2196F3;
            background-color: #e3f2fd;
        }
        
        .spacer-column {
            cursor: default;
        }
        
        .minus-column {
            cursor: default;
        }
        
        .minus-sign {
            font-size: 32px;
            font-weight: bold;
            color: #f44336;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }
        
        .line {
            margin: 10px 0;
        }
        
        .underline {
            width: 240px;
            height: 3px;
            background-color: #333;
            margin: 0 20px;
        }
        
        .answer-digit {
            font-size: 32px;
            font-weight: bold;
            text-align: center;
            width: 50px;
            height: 50px;
            border: 3px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
            color: #333;
            font-family: 'Courier New', monospace;
        }
        
        .answer-digit.active {
            border-color: #2196F3;
            background-color: #e3f2fd;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.5);
        }
        
        .answer-digit.correct {
            border-color: #4CAF50;
            background-color: #e8f5e8;
            color: #2e7d32;
        }
        
        .answer-digit.incorrect {
            border-color: #f44336;
            background-color: #ffebee;
            color: #c62828;
        }
        
        .number-pad {
            margin-top: 25px;
            display: grid;
            gap: 10px;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .number-row {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .number-btn {
            width: 60px;
            height: 60px;
            font-size: 24px;
            font-weight: bold;
            border: 2px solid #ddd;
            border-radius: 8px;
            background-color: #f5f5f5;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .number-btn:hover {
            background-color: #e0e0e0;
            transform: translateY(-2px);
        }
        
        .number-btn:active {
            transform: translateY(0);
        }
        
        .number-btn.clear-btn {
            background-color: #ff9800;
            color: white;
            border-color: #f57c00;
            font-size: 20px;
        }
        
        .number-btn.clear-btn:hover {
            background-color: #f57c00;
        }
        
        .number-btn.check-btn {
            background-color: #4CAF50;
            color: white;
            border-color: #2e7d32;
            font-size: 24px;
        }
        
        .number-btn.check-btn:hover {
            background-color: #2e7d32;
        }
        
        .number-btn.reset-problem-btn {
            background-color: #9C27B0;
            color: white;
            border-color: #7B1FA2;
            font-size: 14px;
            width: 190px;
        }
        
        .number-btn.reset-problem-btn:hover {
            background-color: #7B1FA2;
        }
        
        .number-btn:disabled {
            background-color: #ccc !important;
            color: #666 !important;
            cursor: not-allowed !important;
            transform: none !important;
        }
        
        .number-btn:disabled:hover {
            background-color: #ccc !important;
            transform: none !important;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background-color: #2196F3;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1976D2;
        }
        
        .btn-primary:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background-color: #4CAF50;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #45a049;
        }
        
        .btn-secondary:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .btn-danger {
            background-color: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #d32f2f;
        }
        
        .feedback {
            margin: 20px 0;
            font-size: 18px;
            font-weight: bold;
            min-height: 30px;
        }
        
        .feedback.correct {
            color: #4CAF50;
        }
        
        .feedback.incorrect {
            color: #f44336;
        }
        
        .feedback.info {
            color: #2196F3;
        }
        
        .home-link {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: #2196F3;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .home-link:hover {
            background-color: #1976D2;
        }
        
        .win-message {
            background-color: #4CAF50;
            color: white;
            padding: 30px;
            border-radius: 15px;
            font-size: 28px;
            font-weight: bold;
            margin: 30px 0;
            display: none;
            animation: celebration 2s ease-in-out infinite;
        }
        
        .game-rules {
            background-color: #fff3e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            font-size: 14px;
            color: #e65100;
            text-align: left;
        }
        
        .game-rules h3 {
            color: #bf360c;
            margin-top: 0;
        }
        
        @media (max-width: 768px) {
            .game-container {
                padding: 15px;
                margin: 10px;
            }
            
            .players-container {
                gap: 15px;
            }
            
            .player-display {
                padding: 15px;
            }
            
            .player-name {
                font-size: 18px;
                margin-bottom: 10px;
            }
            
            .player-value {
                font-size: 32px;
            }
            
            .tower-visual {
                height: 80px;
                margin: 10px 0;
            }
            
            .problem-area {
                padding: 12px;
                margin: 10px 0;
                border-radius: 8px;
            }
            
            .current-turn {
                font-size: 14px;
                margin-bottom: 8px;
            }
            
            .problem-control {
                gap: 15px;
                margin-top: 10px;
            }
            
            .problem-display {
                font-size: 14px;
            }
            
            .spinner {
                width: 50px;
                height: 50px;
                border: 2px solid #333;
            }
            
            .spinner-center {
                width: 24px;
                height: 24px;
                font-size: 8px;
                border: 1px solid #333;
            }
            
            .subtraction-problem {
                padding: 20px;
            }
            
            .digit {
                font-size: 24px;
                width: 40px;
                height: 40px;
            }
            
            .answer-digit {
                font-size: 24px;
                width: 40px;
                height: 40px;
            }
            
            .number-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .number-btn.reset-problem-btn {
                width: 160px;
                font-size: 12px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 200px;
            }
        }
    </style>
</head>
<body>
    <a href="../../index.html" class="home-link">← Home</a>
    
    <div class="game-container">
        <h1>Subtraction Tower</h1>
        
        
        <div class="players-container">
            <div class="player-display active" id="player1-display">
                <div class="player-name">Player 1</div>
                <div class="player-value" id="player1-value">500</div>
                <div class="tower-visual">
                    <div class="tower-progress" id="player1-progress" style="height: 0%;"></div>
                </div>
            </div>
            
            <div class="player-display" id="player2-display">
                <div class="player-name">Player 2</div>
                <div class="player-value" id="player2-value">500</div>
                <div class="tower-visual">
                    <div class="tower-progress" id="player2-progress" style="height: 0%;"></div>
                </div>
            </div>
        </div>
        
        <div class="problem-area">
            <div class="current-turn" id="current-turn">Player 1's Turn</div>
            <div class="problem-control">
                <div class="spinner-container">
                    <div class="spinner" id="spinner">
                        <div class="spinner-center" id="spinner-value">SPIN</div>
                    </div>
                </div>
                <div class="problem-display" id="problem-display">Click the spinner to start!</div>
            </div>
        </div>
        
        <div class="subtraction-workspace" id="subtraction-workspace" style="display: none;">
            <div class="workspace-title">Solve the Subtraction Problem!</div>
            <div class="subtraction-problem" id="subtraction-display">
                <div class="problem-row top-number" id="top-number">
                    <div class="digit-column spacer-column"></div>
                    <div class="digit-column" data-place="hundreds">
                        <div class="borrow-indicator" id="borrow-hundreds"></div>
                        <div class="digit" id="digit-hundreds-top">5</div>
                    </div>
                    <div class="digit-column" data-place="tens">
                        <div class="borrow-indicator" id="borrow-tens"></div>
                        <div class="digit" id="digit-tens-top">0</div>
                    </div>
                    <div class="digit-column" data-place="ones">
                        <div class="borrow-indicator" id="borrow-ones"></div>
                        <div class="digit" id="digit-ones-top">0</div>
                    </div>
                </div>
                <div class="problem-row subtract-number" id="subtract-number">
                    <div class="digit-column minus-column">
                        <div class="minus-sign">-</div>
                    </div>
                    <div class="digit-column">
                        <div class="digit" id="digit-hundreds-sub">0</div>
                    </div>
                    <div class="digit-column">
                        <div class="digit" id="digit-tens-sub">0</div>
                    </div>
                    <div class="digit-column">
                        <div class="digit" id="digit-ones-sub">0</div>
                    </div>
                </div>
                <div class="problem-row line">
                    <div class="underline"></div>
                </div>
                <div class="problem-row answer-row" id="answer-row">
                    <div class="digit-column spacer-column"></div>
                    <div class="digit-column">
                        <input type="text" class="answer-digit" id="answer-hundreds" maxlength="1" readonly>
                    </div>
                    <div class="digit-column">
                        <input type="text" class="answer-digit" id="answer-tens" maxlength="1" readonly>
                    </div>
                    <div class="digit-column">
                        <input type="text" class="answer-digit active" id="answer-ones" maxlength="1" readonly>
                    </div>
                </div>
            </div>
            
            <div class="number-pad" id="number-pad">
                <div class="number-row">
                    <button class="number-btn" data-number="1">1</button>
                    <button class="number-btn" data-number="2">2</button>
                    <button class="number-btn" data-number="3">3</button>
                </div>
                <div class="number-row">
                    <button class="number-btn" data-number="4">4</button>
                    <button class="number-btn" data-number="5">5</button>
                    <button class="number-btn" data-number="6">6</button>
                </div>
                <div class="number-row">
                    <button class="number-btn" data-number="7">7</button>
                    <button class="number-btn" data-number="8">8</button>
                    <button class="number-btn" data-number="9">9</button>
                </div>
                <div class="number-row">
                    <button class="number-btn clear-btn">🗑️</button>
                    <button class="number-btn" data-number="0">0</button>
                    <button class="number-btn check-btn">✓</button>
                </div>
                <div class="number-row">
                    <button class="number-btn reset-problem-btn">Reset Problem</button>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-danger" id="new-game-btn">New Game</button>
        </div>
        
        <div class="feedback" id="feedback"></div>
        
        <div class="win-message" id="win-message">
            🎉 Congratulations! You've reached the bottom of the tower! 🎉
        </div>
    </div>

    <script>
        class SubtractionTowerGame {
            constructor() {
                this.player1Value = 500;
                this.player2Value = 500;
                this.currentPlayer = 1;
                this.gameActive = true;
                this.currentProblem = 0;
                this.gameState = 'waiting'; // 'waiting', 'spinning', 'solving'
                
                // Problem state
                this.topNumber = 0;
                this.subtractNumber = 0;
                this.correctAnswer = 0;
                this.currentDigits = { hundreds: 0, tens: 0, ones: 0 };
                this.borrowedDigits = { hundreds: 0, tens: 0, ones: 0 };
                this.activeInputIndex = 2; // Start with ones place (right to left: 2, 1, 0)
                this.userAnswer = ['', '', '']; // hundreds, tens, ones
                
                this.initializeElements();
                this.bindEvents();
                this.updateDisplay();
            }
            
            initializeElements() {
                this.elements = {
                    player1Display: document.getElementById('player1-display'),
                    player2Display: document.getElementById('player2-display'),
                    player1Value: document.getElementById('player1-value'),
                    player2Value: document.getElementById('player2-value'),
                    player1Progress: document.getElementById('player1-progress'),
                    player2Progress: document.getElementById('player2-progress'),
                    currentTurn: document.getElementById('current-turn'),
                    problemDisplay: document.getElementById('problem-display'),
                    spinner: document.getElementById('spinner'),
                    spinnerValue: document.getElementById('spinner-value'),
                    subtractionWorkspace: document.getElementById('subtraction-workspace'),
                    
                    // Subtraction problem elements
                    digitHundredsTop: document.getElementById('digit-hundreds-top'),
                    digitTensTop: document.getElementById('digit-tens-top'),
                    digitOnesTop: document.getElementById('digit-ones-top'),
                    digitHundredsSub: document.getElementById('digit-hundreds-sub'),
                    digitTensSub: document.getElementById('digit-tens-sub'),
                    digitOnesSub: document.getElementById('digit-ones-sub'),
                    borrowHundreds: document.getElementById('borrow-hundreds'),
                    borrowTens: document.getElementById('borrow-tens'),
                    borrowOnes: document.getElementById('borrow-ones'),
                    answerHundreds: document.getElementById('answer-hundreds'),
                    answerTens: document.getElementById('answer-tens'),
                    answerOnes: document.getElementById('answer-ones'),
                    
                    // Controls
                    newGameBtn: document.getElementById('new-game-btn'),
                    feedback: document.getElementById('feedback'),
                    winMessage: document.getElementById('win-message')
                };
                
                // Get all digit columns and number buttons (skip spacer column)
                this.digitColumns = document.querySelectorAll('.top-number .digit-column[data-place]');
                this.numberButtons = document.querySelectorAll('.number-btn[data-number]');
                this.clearButton = document.querySelector('.clear-btn');
                this.checkButton = document.querySelector('.check-btn');
                this.resetProblemButton = document.querySelector('.reset-problem-btn');
                this.answerInputs = [this.elements.answerHundreds, this.elements.answerTens, this.elements.answerOnes];
            }
            
            bindEvents() {
                this.elements.spinner.addEventListener('click', () => this.spin());
                this.elements.newGameBtn.addEventListener('click', () => this.newGame());
                
                // Digit column borrowing
                this.digitColumns.forEach((column, index) => {
                    column.addEventListener('click', () => this.handleBorrow(index));
                });
                
                // Number pad events
                this.numberButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const number = button.getAttribute('data-number');
                        this.handleNumberInput(number);
                    });
                });
                
                this.clearButton.addEventListener('click', () => this.clearCurrentInput());
                this.checkButton.addEventListener('click', () => this.checkAnswer());
                this.resetProblemButton.addEventListener('click', () => this.resetCurrentProblem());
                
                // Answer input navigation
                this.answerInputs.forEach((input, index) => {
                    input.addEventListener('click', () => this.setActiveInput(index));
                });
            }
            
            updateDisplay() {
                // Update player values
                this.elements.player1Value.textContent = this.player1Value;
                this.elements.player2Value.textContent = this.player2Value;
                
                // Update progress bars (500 -> 0, so progress increases as value decreases)
                const player1Progress = ((500 - this.player1Value) / 500) * 100;
                const player2Progress = ((500 - this.player2Value) / 500) * 100;
                this.elements.player1Progress.style.height = `${player1Progress}%`;
                this.elements.player2Progress.style.height = `${player2Progress}%`;
                
                // Update active player display
                this.elements.player1Display.classList.toggle('active', this.currentPlayer === 1);
                this.elements.player2Display.classList.toggle('active', this.currentPlayer === 2);
                
                // Update turn indicator
                this.elements.currentTurn.textContent = `Player ${this.currentPlayer}'s Turn`;
            }
            
            spin() {
                console.log('Spin clicked, gameActive:', this.gameActive, 'gameState:', this.gameState);
                if (!this.gameActive || this.gameState !== 'waiting') return;
                
                this.gameState = 'spinning';
                this.elements.spinner.style.pointerEvents = 'none'; // Disable clicking during spin
                this.elements.spinner.classList.add('spinning');
                this.clearFeedback();
                
                console.log('Starting spinner animation...');
                // Animate spinner for 2 seconds
                setTimeout(() => {
                    console.log('Timeout executed, calling generateProblem...');
                    this.elements.spinner.style.pointerEvents = 'auto';
                    this.generateProblem();
                }, 2000);
            }
            
            generateProblem() {
                console.log('generateProblem called');
                const currentValue = this.currentPlayer === 1 ? this.player1Value : this.player2Value;
                console.log('Current value:', currentValue);
                
                // Generate subtraction amount (10-200)
                let subtractAmount = Math.floor(Math.random() * 190) + 10; // 10-199
                subtractAmount = Math.min(subtractAmount, currentValue); // Don't go below 0
                
                this.topNumber = currentValue;
                this.subtractNumber = subtractAmount;
                this.correctAnswer = currentValue - subtractAmount;
                this.currentProblem = subtractAmount;
                
                // Reset borrowing state
                this.currentDigits = {
                    hundreds: Math.floor(currentValue / 100),
                    tens: Math.floor((currentValue % 100) / 10),
                    ones: currentValue % 10
                };
                this.borrowedDigits = { hundreds: 0, tens: 0, ones: 0 };
                this.userAnswer = ['', '', ''];
                this.activeInputIndex = 2; // Start with ones
                
                console.log('Problem:', currentValue, '-', subtractAmount, '=', this.correctAnswer);
                
                // Update display
                this.elements.spinner.classList.remove('spinning');
                this.elements.spinnerValue.textContent = subtractAmount;
                this.elements.problemDisplay.textContent = `${currentValue} - ${subtractAmount} = ?`;
                
                this.showSubtractionWorkspace();
            }
            
            showSubtractionWorkspace() {
                this.gameState = 'solving';
                this.elements.subtractionWorkspace.style.display = 'block';
                
                // Update the subtraction problem display
                this.updateSubtractionProblem();
                this.setActiveInput(2); // Start with ones place
            }
            
            updateSubtractionProblem() {
                // Update top number (with current borrowing state)
                const displayHundreds = this.currentDigits.hundreds + this.borrowedDigits.hundreds;
                const displayTens = this.currentDigits.tens + this.borrowedDigits.tens;
                const displayOnes = this.currentDigits.ones + this.borrowedDigits.ones;
                
                this.elements.digitHundredsTop.textContent = displayHundreds;
                this.elements.digitTensTop.textContent = displayTens;
                this.elements.digitOnesTop.textContent = displayOnes;
                
                // Update subtract number
                this.elements.digitHundredsSub.textContent = Math.floor(this.subtractNumber / 100);
                this.elements.digitTensSub.textContent = Math.floor((this.subtractNumber % 100) / 10);
                this.elements.digitOnesSub.textContent = this.subtractNumber % 10;
                
                // Update borrow indicators
                this.updateBorrowIndicators();
            }
            
            updateBorrowIndicators() {
                // Show borrowed amounts as small numbers
                this.elements.borrowHundreds.textContent = this.borrowedDigits.hundreds || '';
                this.elements.borrowTens.textContent = this.borrowedDigits.tens || '';
                this.elements.borrowOnes.textContent = this.borrowedDigits.ones || '';
                
                this.elements.borrowHundreds.classList.toggle('show', this.borrowedDigits.hundreds > 0);
                this.elements.borrowTens.classList.toggle('show', this.borrowedDigits.tens > 0);
                this.elements.borrowOnes.classList.toggle('show', this.borrowedDigits.ones > 0);
                
                console.log('Borrow indicators updated:', this.borrowedDigits);
            }
            
            handleBorrow(columnIndex) {
                console.log('Borrow clicked, column:', columnIndex, 'game state:', this.gameState);
                if (this.gameState !== 'solving') return;
                
                const places = ['hundreds', 'tens', 'ones'];
                const fromPlace = places[columnIndex];
                const toPlace = places[columnIndex + 1];
                
                console.log('Borrowing from', fromPlace, 'to', toPlace);
                
                // Can't borrow from ones place (rightmost)
                if (columnIndex === 2) {
                    console.log('Cannot borrow from ones place');
                    return;
                }
                
                // Can't borrow if there's nothing to borrow
                const currentValue = this.currentDigits[fromPlace] + this.borrowedDigits[fromPlace];
                console.log('Available to borrow from', fromPlace, ':', currentValue);
                
                if (currentValue <= 0) {
                    this.showFeedback('Cannot borrow - no value available!', 'incorrect');
                    return;
                }
                
                // Perform the borrowing
                this.currentDigits[fromPlace]--;
                this.borrowedDigits[toPlace] += 10;
                
                console.log('After borrowing - currentDigits:', this.currentDigits, 'borrowedDigits:', this.borrowedDigits);
                
                this.updateSubtractionProblem();
                this.showFeedback(`Borrowed 1 from ${fromPlace} to ${toPlace}`, 'info');
                
                setTimeout(() => this.clearFeedback(), 1500);
            }
            
            setActiveInput(index) {
                this.activeInputIndex = index;
                this.answerInputs.forEach((input, i) => {
                    input.classList.toggle('active', i === index);
                });
            }
            
            handleNumberInput(number) {
                if (this.gameState !== 'solving') return;
                
                this.userAnswer[this.activeInputIndex] = number;
                this.answerInputs[this.activeInputIndex].value = number;
                
                // Move to next input (left)
                if (this.activeInputIndex > 0) {
                    this.setActiveInput(this.activeInputIndex - 1);
                }
            }
            
            clearCurrentInput() {
                if (this.gameState !== 'solving') return;
                
                this.userAnswer[this.activeInputIndex] = '';
                this.answerInputs[this.activeInputIndex].value = '';
                
                // Clear visual feedback
                this.answerInputs.forEach(input => {
                    input.classList.remove('correct', 'incorrect');
                });
            }
            
            resetCurrentProblem() {
                if (this.gameState !== 'solving') return;
                
                // Reset to original problem state
                this.currentDigits = {
                    hundreds: Math.floor(this.topNumber / 100),
                    tens: Math.floor((this.topNumber % 100) / 10),
                    ones: this.topNumber % 10
                };
                this.borrowedDigits = { hundreds: 0, tens: 0, ones: 0 };
                this.userAnswer = ['', '', ''];
                this.activeInputIndex = 2;
                
                // Clear answer inputs
                this.answerInputs.forEach(input => {
                    input.value = '';
                    input.classList.remove('active', 'correct', 'incorrect');
                });
                
                // Update display
                this.updateSubtractionProblem();
                this.setActiveInput(2);
                
                this.showFeedback('Problem reset to original state', 'info');
                setTimeout(() => this.clearFeedback(), 1500);
            }
            
            checkAnswer() {
                if (this.gameState !== 'solving') return;
                
                // Build user's answer
                const userAnswerStr = this.userAnswer.join('');
                const userAnswerNum = parseInt(userAnswerStr) || 0;
                
                console.log('User answer:', userAnswerNum, 'Correct answer:', this.correctAnswer);
                
                if (userAnswerNum === this.correctAnswer) {
                    // Correct!
                    this.answerInputs.forEach(input => {
                        input.classList.add('correct');
                        input.classList.remove('incorrect');
                    });
                    
                    this.showFeedback('🎉 Correct! Applying subtraction...', 'correct');
                    
                    // Grey out buttons during transition
                    this.disableButtons();
                    
                    setTimeout(() => {
                        this.executeSubtraction();
                    }, 2000);
                } else {
                    // Incorrect
                    this.answerInputs.forEach(input => {
                        input.classList.add('incorrect');
                        input.classList.remove('correct');
                    });
                    
                    this.showFeedback(`Not quite right. The answer is ${this.correctAnswer}`, 'incorrect');
                }
            }
            
            disableButtons() {
                this.numberButtons.forEach(btn => btn.disabled = true);
                this.clearButton.disabled = true;
                this.checkButton.disabled = true;
                this.resetProblemButton.disabled = true;
            }
            
            enableButtons() {
                this.numberButtons.forEach(btn => btn.disabled = false);
                this.clearButton.disabled = false;
                this.checkButton.disabled = false;
                this.resetProblemButton.disabled = false;
            }
            
            executeSubtraction() {
                
                const currentValue = this.currentPlayer === 1 ? this.player1Value : this.player2Value;
                const newValue = currentValue - this.currentProblem;
                
                // Update player value
                if (this.currentPlayer === 1) {
                    this.player1Value = newValue;
                } else {
                    this.player2Value = newValue;
                }
                
                this.updateDisplay();
                
                // Check win condition
                if (newValue === 0) {
                    this.gameWon();
                    return;
                } else if (newValue < 0) {
                    // This shouldn't happen with our logic, but just in case
                    this.showFeedback('Oops! That would go below 0. Let\'s try a different problem.', 'incorrect');
                    this.nextTurn();
                    return;
                }
                
                this.showFeedback(`${currentValue} - ${this.currentProblem} = ${newValue}. Next player's turn!`, 'info');
                
                setTimeout(() => {
                    this.nextTurn();
                }, 2000);
            }
            
            gameWon() {
                this.gameActive = false;
                this.elements.winMessage.style.display = 'block';
                
                // Highlight winner
                if (this.currentPlayer === 1) {
                    this.elements.player1Display.classList.add('winner');
                } else {
                    this.elements.player2Display.classList.add('winner');
                }
                
                this.elements.subtractionWorkspace.style.display = 'none';
                this.elements.spinner.style.pointerEvents = 'none';
                
                this.showFeedback(`🎉 Player ${this.currentPlayer} wins! 🎉`, 'correct');
            }
            
            nextTurn() {
                this.currentPlayer = this.currentPlayer === 1 ? 2 : 1;
                this.gameState = 'waiting';
                this.currentProblem = 0;
                
                // Reset problem state
                this.topNumber = 0;
                this.subtractNumber = 0;
                this.correctAnswer = 0;
                this.currentDigits = { hundreds: 0, tens: 0, ones: 0 };
                this.borrowedDigits = { hundreds: 0, tens: 0, ones: 0 };
                this.activeInputIndex = 2;
                this.userAnswer = ['', '', ''];
                
                this.elements.subtractionWorkspace.style.display = 'none';
                this.elements.spinner.style.pointerEvents = 'auto';
                
                this.elements.problemDisplay.textContent = 'Click the spinner to continue!';
                this.elements.spinnerValue.textContent = 'SPIN';
                
                // Clear answer inputs and re-enable buttons
                this.answerInputs.forEach(input => {
                    input.value = '';
                    input.classList.remove('active', 'correct', 'incorrect');
                });
                this.enableButtons();
                
                this.updateDisplay();
                this.clearFeedback();
            }
            
            newGame() {
                this.player1Value = 500;
                this.player2Value = 500;
                this.currentPlayer = 1;
                this.gameActive = true;
                this.gameState = 'waiting';
                this.currentProblem = 0;
                
                // Reset problem state
                this.topNumber = 0;
                this.subtractNumber = 0;
                this.correctAnswer = 0;
                this.currentDigits = { hundreds: 0, tens: 0, ones: 0 };
                this.borrowedDigits = { hundreds: 0, tens: 0, ones: 0 };
                this.activeInputIndex = 2;
                this.userAnswer = ['', '', ''];
                
                // Reset UI
                this.elements.player1Display.classList.remove('winner');
                this.elements.player2Display.classList.remove('winner');
                this.elements.subtractionWorkspace.style.display = 'none';
                this.elements.winMessage.style.display = 'none';
                this.elements.spinner.style.pointerEvents = 'auto';
                
                this.elements.problemDisplay.textContent = 'Click the spinner to start!';
                this.elements.spinnerValue.textContent = 'SPIN';
                
                // Clear answer inputs and enable buttons
                this.answerInputs.forEach(input => {
                    input.value = '';
                    input.classList.remove('active', 'correct', 'incorrect');
                });
                this.enableButtons();
                
                this.updateDisplay();
                this.clearFeedback();
            }
            
            showFeedback(message, type) {
                this.elements.feedback.textContent = message;
                this.elements.feedback.className = `feedback ${type}`;
            }
            
            clearFeedback() {
                this.elements.feedback.textContent = '';
                this.elements.feedback.className = 'feedback';
            }
        }
        
        // Initialize the game when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new SubtractionTowerGame();
        });
    </script>
</body>
</html>